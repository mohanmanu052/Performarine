<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=no">
  <meta name="description" content="API docs for the startBGLocatorTrip method from the StartTrip class, for the Dart programming language.">
  <title>startBGLocatorTrip method - StartTrip class - start_trip library - Dart API</title>


  
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" rel="stylesheet">
  
  <link rel="stylesheet" href="../../static-assets/github.css?v1">
  <link rel="stylesheet" href="../../static-assets/styles.css?v1">
  <link rel="icon" href="../../static-assets/favicon.png?v1">

  
</head>


<body data-base-href="../../" data-using-base-href="false" class="light-theme">

<div id="overlay-under-drawer"></div>

<header id="title">
  <span id="sidenav-left-toggle" class="material-symbols-outlined" role="button" tabindex="0">menu</span>
  <ol class="breadcrumbs gt-separated dark hidden-xs">
    <li><a href="../../index.html">performarine</a></li>
    <li><a href="../../analytics_start_trip/analytics_start_trip-library.html">start_trip</a></li>
    <li><a href="../../analytics_start_trip/StartTrip-class.html">StartTrip</a></li>
    <li class="self-crumb">startBGLocatorTrip method</li>
  </ol>
  <div class="self-name">startBGLocatorTrip</div>
  <form class="search navbar-right" role="search">
    <input type="text" id="search-box" autocomplete="off" disabled class="form-control typeahead" placeholder="Loading search...">
  </form>
  <div class="toggle" id="theme-button">
    <label for="theme">
      <input type="checkbox" id="theme" value="light-theme">
      <span class="material-symbols-outlined">
        brightness_4
      </span>
    </label>
  </div>
</header>
<main>

  <div id="dartdoc-main-content" class="main-content">
      <div>
<h1><span class="kind-method">startBGLocatorTrip</span> method 
    <a href="https://dart.dev/null-safety" class="feature feature-null-safety" title="Supports the null safety language feature.">Null safety</a>
</h1></div>

    <section class="multi-line-signature">
      

<span class="returntype"><a href="https://api.flutter.dev/flutter/dart-async/Future-class.html">Future</a><span class="signature">&lt;<wbr><span class="type-parameter">void</span>&gt;</span></span>
<span class="name ">startBGLocatorTrip</span>(<wbr><ol class="parameter-list"><li><span class="parameter" id="startBGLocatorTrip-param-tripId"><span class="type-annotation"><a href="https://api.flutter.dev/flutter/dart-core/String-class.html">String</a></span> <span class="parameter-name">tripId</span>, </span></li>
<li><span class="parameter" id="startBGLocatorTrip-param-dateTime"><span class="type-annotation"><a href="https://api.flutter.dev/flutter/dart-core/DateTime-class.html">DateTime</a></span> <span class="parameter-name">dateTime</span></span></li>
</ol>)

      

    </section>
    
<section class="desc markdown">
  <p>In this function we start to listen to the data coming from background locator port</p>
</section>


    
<section class="summary source-code" id="source">
  <h2><span>Implementation</span></h2>
  <pre class="language-dart"><code class="language-dart">Future&lt;void&gt; startBGLocatorTrip(String tripId, DateTime dateTime) async {
  ReceivePort port = ReceivePort();

  if (IsolateNameServer.lookupPortByName(
          LocationServiceRepository.isolateName) !=
      null) {
    IsolateNameServer.removePortNameMapping(
        LocationServiceRepository.isolateName);
  }

  IsolateNameServer.registerPortWithName(
      port.sendPort, LocationServiceRepository.isolateName);

  SharedPreferences pref = await SharedPreferences.getInstance();

  final currentTrip = await _databaseService.getTrip(tripId);

  DateTime createdAtTime = DateTime.parse(currentTrip.createdAt!);

  int fileIndex = 0;

  gyroscopeAvailable =
      await s.SensorManager().isSensorAvailable(s.Sensors.GYROSCOPE);
  accelerometerAvailable =
      await s.SensorManager().isSensorAvailable(s.Sensors.ACCELEROMETER);
  magnetometerAvailable =
      await s.SensorManager().isSensorAvailable(s.Sensors.MAGNETIC_FIELD);
  userAccelerometerAvailable = await s.SensorManager()
      .isSensorAvailable(s.Sensors.LINEAR_ACCELERATION);

  if (accelerometerAvailable) {
    accelerometerEvents.listen(
      (AccelerometerEvent event) {
        _accelerometerValues = &lt;double&gt;[event.x, event.y, event.z];
      },
    );
  }

  if (gyroscopeAvailable) {
    gyroscopeEvents.listen(
      (GyroscopeEvent event) {
        _gyroscopeValues = &lt;double&gt;[event.x, event.y, event.z];
      },
    );
  }

  if (userAccelerometerAvailable) {
    userAccelerometerEvents.listen(
      (UserAccelerometerEvent event) {
        _userAccelerometerValues = &lt;double&gt;[event.x, event.y, event.z];
      },
    );
  }

  if (magnetometerAvailable) {
    magnetometerEvents.listen(
      (MagnetometerEvent event) {
        _magnetometerValues = &lt;double&gt;[event.x, event.y, event.z];
      },
    );
  }

  print(&quot;AFTER SESNOR DATA&quot;);

  double endTripLatitude = 0.0;
  double endTripLongitude = 0.0;
  double finalTripDistance = 0.0;
  double speed = 0.0;

  String mobileFileName = &#39;mobile_$fileIndex.csv&#39;;
  String lprFileName = &#39;lpr_$fileIndex.csv&#39;;

  print(&quot;BEFORE PORT LISTEN&quot;);
  &#47;&#47; Future&lt;bool&gt; hasActiveNotifications() async {
  &#47;&#47;   var activeNotifications = await flutterLocalNotificationsPlugin
  &#47;&#47;       .resolvePlatformSpecificImplementation&lt;
  &#47;&#47;           AndroidFlutterLocalNotificationsPlugin&gt;()
  &#47;&#47;       ?.getActiveNotifications();
  &#47;&#47;
  &#47;&#47;   return activeNotifications?.isEmpty ?? true;
  &#47;&#47; }

  var activeNotifications = await flutterLocalNotificationsPlugin
      .resolvePlatformSpecificImplementation&lt;
          AndroidFlutterLocalNotificationsPlugin&gt;()
      ?.getActiveNotifications();

&#47;&#47;Todo: Notification spanning on port listen it will generate the notification continuously
  port.listen((dynamic data) async {
    LocationDto? locationDto =
        data != null ? LocationDto.fromJson(data) : null;

    print(&quot;LOCATION DTO $locationDto&quot;);

    if (locationDto != null) {
      endTripLatitude = locationDto.latitude;
      endTripLongitude = locationDto.longitude;
      speed = locationDto.speed &lt; 0 ? 0 : locationDto.speed;
      accuracy = locationDto.accuracy;
      altitide = locationDto.altitude;
      heading = locationDto.heading;
      speedAccuracy = locationDto.speedAccuracy;

      Utils.customPrint(&#39;SPEED SPEED 1111 ${speed}&#39;);
      Utils.customPrint(&#39;SPEED SPEED 2222 ${locationDto.speed}&#39;);

      List&lt;String&gt; currentLocList =
          pref.getStringList(&#39;current_loc_list&#39;) ?? [];

      Position _currentPosition = Position(
          latitude: locationDto.latitude,
          longitude: locationDto.longitude,
          timestamp: null,
          accuracy: 0.0,
          speed: 0.0,
          speedAccuracy: 0.0,
          heading: 0.0,
          altitude: 0.0);

      String currentPosStr =
          [_currentPosition.latitude, _currentPosition.longitude].join(&#39;,&#39;);

      currentLocList.add(currentPosStr);
      pref.setStringList(&quot;current_loc_list&quot;, currentLocList);

      if (currentLocList.length &gt; 1) {
        String previousPosStr =
            currentLocList.elementAt(currentLocList.length - 2);
        Position _previousPosition = Position(
            latitude: double.parse(previousPosStr.split(&#39;,&#39;).first.trim()),
            longitude: double.parse(previousPosStr.split(&#39;,&#39;).last.trim()),
            timestamp: null,
            accuracy: 0.0,
            speed: 0.0,
            speedAccuracy: 0.0,
            heading: 0.0,
            altitude: 0.0);

        var _distanceBetweenLastTwoLocations = Geolocator.distanceBetween(
          _previousPosition.latitude,
          _previousPosition.longitude,
          _currentPosition.latitude,
          _currentPosition.longitude,
        );

        finalTripDistance += _distanceBetweenLastTwoLocations;
        debugPrint(&#39;Total Distance: $finalTripDistance&#39;);
        pref.setDouble(&#39;temp_trip_dist&#39;, finalTripDistance);
        String tripDistanceForStorage =
            Calculation().calculateDistance(finalTripDistance);

        Duration diff = DateTime.now().toUtc().difference(createdAtTime);

        pref.setString(&#39;tripDistance&#39;, tripDistanceForStorage);

        int finalTripDuration = (diff.inMilliseconds);

        &#47;&#47;&#47; Here is the actual trip duration
        print(&#39;FINAL TRIP DUR RRR : $finalTripDuration&#39;);

        &#47;&#47;&#47; DURATION 00:00:00
        String tripDurationForStorage =
            Utils.calculateTripDuration((finalTripDuration ~&#47; 1000).toInt());

        &#47;&#47;&#47; SPEED
        String tripSpeedForStorage =
            Calculation().calculateCurrentSpeed(speed);
        print(&#39;FINAL TRIP SPEED: $tripSpeedForStorage}&#39;);

        &#47;&#47;&#47; AVG. SPEED

        String tripAvgSpeedForStorage = Calculation()
            .calculateAvgSpeed(finalTripDistance, finalTripDuration);

        Utils.customPrint(&#39;TRIP DURATION: $tripDurationForStorage&#39;);
        Utils.customPrint(&#39;TRIP SPEED 1212: $tripSpeedForStorage&#39;);
        Utils.customPrint(&#39;AVG SPEED: $tripAvgSpeedForStorage&#39;);

        var num = double.parse(tripSpeedForStorage) &lt; 0
            ? 0.0
            : double.parse(tripSpeedForStorage);

        Utils.customPrint(&#39;SPEED SPEED SPEED 666: $num&#39;);

        if (tripDurationTimer != null) {
          if (tripDurationTimer!.isActive) {
            tripDurationTimer!.cancel();
          }
        }

        await flutterLocalNotificationsPlugin.cancel(889);
        tripDurationTimer =
            Timer.periodic(Duration(seconds: 1), (timer) async {
          var durationTime = DateTime.now().toUtc().difference(createdAtTime);
          String tripDuration = Utils.calculateTripDuration(
              ((durationTime.inMilliseconds) ~&#47; 1000).toInt());

          await BackgroundLocator.updateNotificationText(
              title: &#39;&#39;,
              msg: &#39;Trip is in progress&#39;,
              bigMsg:
                  &#39;Duration: $tripDuration        Distance: $tripDistanceForStorage $nauticalMile\nCurrent Speed: $tripSpeedForStorage $knot    Avg Speed: $tripAvgSpeedForStorage $knot&#39;);
        });

        pref.setString(&#39;tripDuration&#39;, tripDurationForStorage);
        &#47;&#47; To get values in Km&#47;h
        pref.setString(&#39;tripSpeed&#39;, num.toString());
        pref.setString(&#39;tripAvgSpeed&#39;, tripAvgSpeedForStorage);

        String filePath = await GetFile().getFile(tripId, mobileFileName);
        String lprFilePath = await GetFile().getFile(tripId, lprFileName);
        File file = File(filePath);
        File lprFile = File(lprFilePath);
        int fileSize = await GetFile().checkFileSize(file);
        int lprFileSize = await GetFile().checkFileSize(lprFile);

        &#47;&#47;&#47; CHECK FOR ONLY 10 KB FOR Testing PURPOSE
        &#47;&#47;&#47; Now File Size is 200000
        if (fileSize &gt;= 200000 &amp;&amp; lprFileSize &gt;= 200000) {
          Utils.customPrint(&#39;STOPPED WRITING&#39;);
          Utils.customPrint(&#39;CREATING NEW FILE&#39;);
          fileIndex = fileIndex + 1;
          mobileFileName = &#39;mobile_$fileIndex.csv&#39;;
          lprFileName = &#39;lpr_$fileIndex.csv&#39;;

          &#47;&#47;&#47; STOP WRITING &amp; CREATE NEW FILE
        } else {
          Utils.customPrint(&#39;WRITING&#39;);
          String gyro = &#39;&#39;, acc = &#39;&#39;, mag = &#39;&#39;, uacc = &#39;&#39;;

          gyro = CreateTrip().convertDataToString(&#39;GYRO&#39;,
              gyroscopeAvailable ? _gyroscopeValues ?? [0.0] : [0.0], tripId);

          acc = CreateTrip().convertDataToString(
              &#39;AAC&#39;,
              accelerometerAvailable ? _accelerometerValues ?? [0.0] : [0.0],
              tripId);

          mag = CreateTrip().convertDataToString(
              &#39;MAG&#39;,
              magnetometerAvailable ? _magnetometerValues ?? [0.0] : [0.0],
              tripId);

          uacc = CreateTrip().convertDataToString(
              &#39;UACC&#39;,
              userAccelerometerAvailable
                  ? _userAccelerometerValues ?? [0.0]
                  : [0.0],
              tripId);

          String location =
              &#39;${endTripLatitude} ${endTripLongitude} ${accuracy.toStringAsFixed(3)} ${altitide.toStringAsFixed(3)} $heading $speed $speedAccuracy&#39;;
          String gps =
              CreateTrip().convertLocationToString(&#39;GPS&#39;, location, tripId);

          String finalString = &#39;&#39;;

          finalString = &#39;$acc\n$uacc\n$gyro\n$mag\n$gps&#39;;

          file.writeAsString(&#39;$finalString\n&#39;, mode: FileMode.append);

          Utils.customPrint(&#39;GPS $gps&#39;);
        }
      }
    }
  });
}</code></pre>
</section>


  </div> <!-- /.main-content -->

  <div id="dartdoc-sidebar-left" class="sidebar sidebar-offcanvas-left">
    <header id="header-search-sidebar" class="hidden-l">
  <form class="search-sidebar" role="search">
    <input type="text" id="search-sidebar" autocomplete="off" disabled class="form-control typeahead" placeholder="Loading search...">
  </form>
</header>

<ol class="breadcrumbs gt-separated dark hidden-l" id="sidebar-nav">
  <li><a href="../../index.html">performarine</a></li>
  <li><a href="../../analytics_start_trip/analytics_start_trip-library.html">start_trip</a></li>
  <li><a href="../../analytics_start_trip/StartTrip-class.html">StartTrip</a></li>
  <li class="self-crumb">startBGLocatorTrip method</li>
</ol>


    <h5>StartTrip class</h5>
    <ol>

        <li class="section-title"><a href="../../analytics_start_trip/StartTrip-class.html#constructors">Constructors</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/StartTrip.html">StartTrip</a></li>


        <li class="section-title">
          <a href="../../analytics_start_trip/StartTrip-class.html#instance-properties">Properties</a>
        </li>
          <li><a href="../../analytics_start_trip/StartTrip/accelerometerAvailable.html">accelerometerAvailable</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/accuracy.html">accuracy</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/altitide.html">altitide</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/gpsSpeed.html">gpsSpeed</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/gyroscopeAvailable.html">gyroscopeAvailable</a></li>
          <li class="inherited"><a href="https://api.flutter.dev/flutter/dart-core/Object/hashCode.html">hashCode</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/heading.html">heading</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/magnetometerAvailable.html">magnetometerAvailable</a></li>
          <li class="inherited"><a href="https://api.flutter.dev/flutter/dart-core/Object/runtimeType.html">runtimeType</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/speedAccuracy.html">speedAccuracy</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/userAccelerometerAvailable.html">userAccelerometerAvailable</a></li>

        <li class="section-title"><a href="../../analytics_start_trip/StartTrip-class.html#instance-methods">Methods</a></li>
          <li class="inherited"><a href="https://api.flutter.dev/flutter/dart-core/Object/noSuchMethod.html">noSuchMethod</a></li>
          <li><a href="../../analytics_start_trip/StartTrip/startBGLocatorTrip.html">startBGLocatorTrip</a></li>
          <li class="inherited"><a href="https://api.flutter.dev/flutter/dart-core/Object/toString.html">toString</a></li>

        <li class="section-title inherited"><a href="../../analytics_start_trip/StartTrip-class.html#operators">Operators</a></li>
          <li class="inherited"><a href="https://api.flutter.dev/flutter/dart-core/Object/operator_equals.html">operator ==</a></li>




</ol>

  </div><!--/.sidebar-offcanvas-->

  <div id="dartdoc-sidebar-right" class="sidebar sidebar-offcanvas-right">
  </div><!--/.sidebar-offcanvas-->

</main>

<footer>
  <span class="no-break">
    performarine
      1.0.0+1
  </span>

  
</footer>



<script src="../../static-assets/highlight.pack.js?v1"></script>
<script src="../../static-assets/docs.dart.js"></script>



</body>

</html>

